<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Water Distribution Management Pro</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root {
      --bg: #f7f9fc;
      --panel: #fff;
      --text: #1f2a3a;
      --muted: #5b6b7e;
      --primary: #1e88e5;
      --success: #2e7d32;
      --danger: #c62828;
      --accent: #6a1b9a;
      --line: #cfd8dc;
      --warning: #f57c00;
      --info: #0288d1;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--text);
      background: var(--bg);
      overflow: hidden;
    }
    
    #map {
      position: absolute;
      inset: 0;
      z-index: 0;
    }
    
    #canvas {
      position: absolute;
      inset: 0;
      z-index: 10;
      pointer-events: none;
    }
    
    #canvas.active {
      pointer-events: auto;
    }
    
    #canvas.drawing {
      cursor: crosshair;
    }
    
    .toolbar {
      position: absolute;
      top: 16px;
      left: 16px;
      width: 56px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    }
    
    .tool-btn {
      width: 56px;
      height: 56px;
      border: none;
      background: var(--panel);
      color: var(--text);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,.08);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: all .2s ease;
    }
    
    .tool-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(0,0,0,.12);
    }
    
    .tool-btn.active {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 8px 24px rgba(30,136,229,.3);
    }
    
    .tool-btn:disabled {
      opacity: .45;
      cursor: not-allowed;
    }

    .tool-btn.layer {
      width: 48px;
      height: 48px;
      font-size: 16px;
    }
    
    .tool-btn.layer.active {
      background: var(--success);
    }

    .toolbar-separator {
      height: 2px;
      background: var(--line);
      margin: 8px 0;
      border-radius: 2px;
    }
    
    .search {
      position: absolute;
      top: 16px;
      left: 86px;
      width: min(600px, 65vw);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .search-bar {
      background: var(--panel);
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,.08);
      border: 1px solid var(--line);
      transition: box-shadow .2s;
    }
    
    .search-bar:focus-within {
      box-shadow: 0 8px 24px rgba(0,0,0,.12);
      border-color: var(--primary);
    }
    
    .search-bar input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 14px;
      color: var(--text);
      background: transparent;
    }
    
    .search-bar .icon-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: #eef4ff;
      color: var(--primary);
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s;
    }
    
    .search-bar .icon-btn:hover {
      background: #d7e5ff;
    }
    
    .suggestions {
      position: relative;
    }
    
    .suggest-list {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      box-shadow: 0 12px 28px rgba(0,0,0,.12);
      overflow: hidden;
      max-height: 420px;
      overflow-y: auto;
    }
    
    .suggest-item {
      padding: 12px 14px;
      cursor: pointer;
      font-size: 13px;
      color: var(--text);
      border-bottom: 1px solid #f2f4f7;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background .15s;
    }
    
    .suggest-item:last-child {
      border-bottom: none;
    }
    
    .suggest-item:hover {
      background: #f4f8ff;
    }
    
    .suggest-item.header {
      font-weight: 700;
      cursor: default;
      background: #fafbfc;
      color: var(--muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .5px;
    }
    
    .suggest-item.header:hover {
      background: #fafbfc;
    }
    
    .suggest-item .match-score {
      font-size: 10px;
      color: #1e88e5;
      background: #eef4ff;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: auto;
    }
    
    .sidebar {
      position: absolute;
      top: 0;
      right: 0;
      width: 480px;
      max-width: 90vw;
      height: 100%;
      background: var(--panel);
      border-left: 1px solid var(--line);
      box-shadow: -18px 0 36px rgba(0,0,0,.08);
      transform: translateX(100%);
      transition: transform .3s cubic-bezier(.4,0,.2,1);
      z-index: 900;
      display: flex;
      flex-direction: column;
    }
    
    .sidebar.open {
      transform: translateX(0);
    }
    
    .sidebar-header {
      padding: 16px 18px;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fafbfc;
    }
    
    .sidebar-title {
      font-size: 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text);
    }
    
    .sidebar-body {
      padding: 16px;
      overflow-y: auto;
      flex: 1;
    }
    
    .card {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 14px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,.04);
    }
    
    .card h4 {
      margin: 0 0 12px 0;
      font-size: 13px;
      font-weight: 700;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
      text-transform: uppercase;
      letter-spacing: .3px;
    }
    
    .row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-top: 1px dashed #eef2f5;
      font-size: 13px;
      align-items: center;
    }
    
    .row:first-child {
      border-top: none;
    }
    
    .label {
      color: var(--muted);
      font-weight: 500;
    }
    
    .value {
      color: var(--text);
      font-weight: 600;
    }
    
    .live-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #4caf50;
      border-radius: 50%;
      margin-right: 6px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }
    
    .btn {
      width: 100%;
      padding: 11px 14px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #f7fafc;
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 600;
      margin-top: 8px;
      transition: all .2s;
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
    }
    
    .btn.primary {
      background: #eef4ff;
      color: var(--primary);
      border-color: #d7e5ff;
    }
    
    .btn.primary:hover {
      background: #d7e5ff;
    }
    
    .btn.success {
      background: #e9f7ee;
      color: var(--success);
      border-color: #cfe9d6;
    }
    
    .btn.success:hover {
      background: #cfe9d6;
    }
    
    .btn.danger {
      background: #fdeaea;
      color: var(--danger);
      border-color: #f7cccc;
    }
    
    .btn.danger:hover {
      background: #f7cccc;
    }
    
    .btn.warning {
      background: #fff4e6;
      color: var(--warning);
      border-color: #ffe0b2;
    }
    
    .btn.warning:hover {
      background: #ffe0b2;
    }
    
    .water-level-container {
      background: linear-gradient(180deg, #e3f2fd 0%, #bbdefb 100%);
      border-radius: 12px;
      padding: 16px;
      margin: 12px 0;
      position: relative;
      overflow: hidden;
    }
    
    .water-tank-visual {
      width: 100%;
      height: 200px;
      position: relative;
      background: #fff;
      border-radius: 8px;
      border: 3px solid #0277bd;
      overflow: hidden;
      box-shadow: inset 0 2px 8px rgba(0,0,0,.1);
    }
    
    .water-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(180deg, #03a9f4 0%, #0288d1 100%);
      transition: height .3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      font-size: 24px;
      text-shadow: 0 2px 4px rgba(0,0,0,.2);
    }
    
    .water-level-slider {
      width: 100%;
      margin-top: 12px;
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      border-radius: 4px;
      background: #e0e0e0;
      outline: none;
    }
    
    .water-level-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #0288d1;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,.2);
    }
    
    .water-level-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #0288d1;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,.2);
      border: none;
    }
    
    .household-stats {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border-radius: 12px;
      padding: 16px;
      margin: 12px 0;
    }
    
    .household-stats h4 {
      color: #fff;
      border-bottom: 2px solid rgba(255,255,255,.3);
      padding-bottom: 8px;
      margin-bottom: 12px;
    }
    
    .stat-big {
      text-align: center;
      margin: 16px 0;
    }
    
    .stat-big-number {
      font-size: 48px;
      font-weight: 700;
      line-height: 1;
      margin-bottom: 4px;
      text-shadow: 0 2px 8px rgba(0,0,0,.3);
    }
    
    .stat-big-label {
      font-size: 13px;
      opacity: .9;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 12px;
      background: rgba(255,255,255,.1);
      border-radius: 8px;
      margin: 8px 0;
    }
    
    .stat-row .label {
      color: rgba(255,255,255,.8);
    }
    
    .stat-row .value {
      color: #fff;
      font-weight: 700;
    }
    
    .valve-hierarchy {
      margin: 12px 0;
    }
    
    .valve-item {
      background: #f8f9fa;
      border-left: 4px solid var(--accent);
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
    }
    
    .valve-item.main {
      border-left-color: var(--primary);
      background: #e3f2fd;
    }
    
    .valve-item.sub {
      margin-left: 24px;
      border-left-color: var(--success);
    }
    
    .valve-item.closed {
      opacity: .6;
      border-left-color: var(--danger);
    }
    
    .valve-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .valve-item-title {
      font-weight: 700;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .valve-item-status {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 600;
    }
    
    .valve-item-status.open {
      background: #e9f7ee;
      color: var(--success);
    }
    
    .valve-item-status.closed {
      background: #fdeaea;
      color: var(--danger);
    }
    
    .valve-item-info {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }
    
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      background: rgba(18,22,28,.35);
      backdrop-filter: blur(2px);
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      width: min(720px, 95vw);
      max-height: 85vh;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.2);
      overflow: hidden;
      animation: modalIn .3s cubic-bezier(.4,0,.2,1);
      display: flex;
      flex-direction: column;
    }
    
    @keyframes modalIn {
      from { opacity: 0; transform: scale(.95); }
      to { opacity: 1; transform: scale(1); }
    }
    
    .modal-header {
      padding: 16px 18px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fafbfc;
      flex-shrink: 0;
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
    }
    
    .close-x {
      border: none;
      background: #f5f7fa;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s;
    }
    
    .close-x:hover {
      background: #e8ecf0;
    }
    
    .modal-body {
      padding: 18px;
      overflow-y: auto;
      flex: 1;
    }
    
    .form-row {
      margin-bottom: 12px;
    }
    
    .form-row label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 600;
    }
    
    .form-row input, .form-row select, .form-row textarea {
      width: 100%;
      padding: 11px 12px;
      border: 1px solid var(--line);
      border-radius: 10px;
      font-size: 13px;
      color: var(--text);
      background: #fff;
      outline: none;
      transition: all .2s;
      font-family: inherit;
    }
    
    .form-row textarea {
      min-height: 60px;
      resize: vertical;
    }
    
    .form-row input:focus, .form-row select:focus, .form-row textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(30,136,229,.1);
    }
    
    .form-row .error {
      font-size: 11px;
      color: var(--danger);
      margin-top: 4px;
    }
    
    .modal-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 16px;
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 3000;
      background: #fff;
      border: 1px solid var(--line);
      color: var(--text);
      padding: 12px 16px;
      border-radius: 10px;
      box-shadow: 0 12px 24px rgba(0,0,0,.15);
      font-size: 13px;
      font-weight: 600;
      display: none;
      animation: toastIn .3s cubic-bezier(.4,0,.2,1);
    }
    
    @keyframes toastIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .zoom {
      position: absolute;
      bottom: 20px;
      left: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 1000;
    }
    
    .zoom .tool-btn {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      font-size: 18px;
    }
    
    .manage-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .manage-item {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 12px;
      background: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    
    .manage-item-info {
      min-width: 0;
      flex: 1;
    }
    
    .manage-item-title {
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
    }
    
    .manage-item-meta {
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .manage-item-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }
    
    .manage-item-actions .btn {
      margin: 0;
      width: auto;
      padding: 8px 12px;
      font-size: 12px;
    }
    
    .tab-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .tab-buttons .btn {
      margin: 0;
    }
    
    .connection-status {
      position: absolute;
      top: 16px;
      right: 16px;
      z-index: 1100;
      background: var(--panel);
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .connection-status.connected {
      color: var(--success);
    }
    
    .connection-status.disconnected {
      color: var(--danger);
    }
    
    .connection-status .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .connection-status.connected .dot {
      background: var(--success);
    }
    
    .connection-status.disconnected .dot {
      background: var(--danger);
    }
    
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,.95);
      z-index: 5000;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 16px;
    }
    
    .loading-overlay.active {
      display: flex;
    }
    
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--line);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Hover Tooltip Styles */
    .hover-tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      z-index: 2000;
      pointer-events: none;
      max-width: 300px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(4px);
      transform: translateY(-10px);
      opacity: 0;
      transition: opacity 0.2s, transform 0.2s;
    }
    
    .hover-tooltip.active {
      opacity: 1;
      transform: translateY(0);
    }
    
    .hover-tooltip .tooltip-title {
      font-weight: 700;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .hover-tooltip .tooltip-row {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
    }
    
    .hover-tooltip .tooltip-label {
      color: #ccc;
    }
    
    .hover-tooltip .tooltip-value {
      color: white;
      font-weight: 600;
    }
    
    .hover-tooltip .status-indicator {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      margin-right: 4px;
    }
    
    .hover-tooltip .status-active {
      background: #4caf50;
    }
    
    .hover-tooltip .status-inactive {
      background: #f44336;
    }
    
    /* Supply Dashboard Styles */
    .supply-dashboard {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 320px;
      background: var(--panel);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,.08);
      border: 1px solid var(--line);
      z-index: 1000;
      overflow: hidden;
    }
    
    .supply-dashboard-header {
      padding: 12px 16px;
      background: #fafbfc;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .supply-dashboard-title {
      font-size: 14px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .supply-dashboard-body {
      padding: 16px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .supply-region {
      margin-bottom: 16px;
      border: 1px solid var(--line);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .supply-region-header {
      padding: 10px 12px;
      background: #f8f9fa;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .supply-region-name {
      font-weight: 600;
      font-size: 13px;
    }
    
    .supply-region-stats {
      display: flex;
      gap: 12px;
      font-size: 11px;
    }
    
    .supply-region-body {
      padding: 12px;
    }
    
    .supply-valve {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px dashed #eef2f5;
    }
    
    .supply-valve:last-child {
      border-bottom: none;
    }
    
    .supply-valve-info {
      flex: 1;
    }
    
    .supply-valve-name {
      font-weight: 600;
      font-size: 12px;
    }
    
    .supply-valve-meta {
      font-size: 10px;
      color: var(--muted);
    }
    
    .supply-valve-status {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }
    
    .supply-valve-status.open {
      background: #e9f7ee;
      color: var(--success);
    }
    
    .supply-valve-status.closed {
      background: #fdeaea;
      color: var(--danger);
    }
    
    .supply-valve-flow {
      font-size: 12px;
      font-weight: 700;
      color: var(--primary);
    }
    
    .supply-summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
    }
    
    .supply-summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    
    .supply-summary-row:last-child {
      margin-bottom: 0;
    }
    
    .supply-summary-label {
      font-size: 11px;
      opacity: .9;
    }
    
    .supply-summary-value {
      font-size: 12px;
      font-weight: 700;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .search {
        width: calc(100% - 100px);
      }
      
      .sidebar {
        width: 90vw;
      }
      
      .supply-dashboard {
        width: 90vw;
        right: 5vw;
        bottom: 80px;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <canvas id="canvas"></canvas>

  <!-- Hover Tooltip -->
  <div id="hoverTooltip" class="hover-tooltip"></div>

  <!-- Supply Dashboard -->
  <div class="supply-dashboard" id="supplyDashboard">
    <div class="supply-dashboard-header">
      <div class="supply-dashboard-title">
        <i class="fas fa-tachometer-alt"></i> Supply Overview
      </div>
      <button class="close-x" id="toggleSupplyDashboard">
        <i class="fas fa-chevron-down"></i>
      </button>
    </div>
    <div class="supply-dashboard-body" id="supplyDashboardBody">
      <!-- Content will be populated by JavaScript -->
    </div>
  </div>

  <div class="connection-status" id="connectionStatus">
    <div class="dot"></div>
    <span id="statusText">Connecting...</span>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div style="font-weight:600;color:var(--text)">Loading System...</div>
  </div>

  <div class="toolbar">
    <button id="toolPipeline" class="tool-btn active" title="Draw pipeline"><i class="fas fa-drafting-compass"></i></button>
    <button id="toolTank" class="tool-btn" title="Add tank"><i class="fas fa-water"></i></button>
    <button id="toolValve" class="tool-btn" title="Add valve"><i class="fas fa-cog"></i></button>
    <button id="toolErase" class="tool-btn" title="Erase pipeline segment"><i class="fas fa-eraser"></i></button>
    <button id="toolManage" class="tool-btn" title="Manage"><i class="fas fa-list"></i></button>
    <button id="toolImport" class="tool-btn" title="Import data"><i class="fas fa-upload"></i></button>
    <button id="toolClear" class="tool-btn" title="Clear all"><i class="fas fa-trash"></i></button>
    
    <div class="toolbar-separator"></div>
    
    <button id="layerStreet" class="tool-btn layer active" title="Street Map"><i class="fas fa-map"></i></button>
    <button id="layerSatellite" class="tool-btn layer" title="Satellite View"><i class="fas fa-satellite"></i></button>
    <button id="layerDark" class="tool-btn layer" title="Dark Mode"><i class="fas fa-moon"></i></button>
  </div>

  <div class="search">
    <div class="search-bar">
      <i class="fas fa-magnifying-glass" style="color:var(--muted)"></i>
      <input id="searchInput" type="text" placeholder="Search devices, places, or areas..." autocomplete="off"/>
      <button id="searchBtn" class="icon-btn" title="Search"><i class="fas fa-arrow-right"></i></button>
    </div>
    <div class="suggestions" id="suggestions" style="display:none">
      <div class="suggest-list" id="suggestList"></div>
    </div>
  </div>

  <div class="zoom">
    <button id="zoomIn" class="tool-btn" title="Zoom in"><i class="fas fa-plus"></i></button>
    <button id="zoomOut" class="tool-btn" title="Zoom out"><i class="fas fa-minus"></i></button>
  </div>

  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title" id="sidebarTitle"><i class="fas fa-info-circle"></i> Details</div>
      <button class="close-x" id="closeSidebar" title="Close"><i class="fas fa-xmark"></i></button>
    </div>
    <div class="sidebar-body" id="sidebarBody"></div>
  </div>

  <!-- Tank Modal -->
  <div class="modal" id="tankModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="tankModalTitle">Add Tank</h3>
        <button class="close-x" data-close="tankModal"><i class="fas fa-xmark"></i></button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <label>Device ID * (Unique identifier)</label>
          <input id="tankId" placeholder="TANK-001" maxlength="50"/>
          <div class="error" id="tankIdError"></div>
        </div>
        <div class="form-row">
          <label>Device ID (Sensor)</label>
          <input id="tankDeviceId" placeholder="ESP32_001" maxlength="50"/>
        </div>
        <div class="form-row"><label>Name *</label><input id="tankName" placeholder="OHSR Tank 1"/></div>
        <div class="form-row">
          <label>Type *</label>
          <select id="tankType">
            <option value="OHSR">OHSR (Overhead Storage Reservoir)</option>
            <option value="GSR">GSR (Ground Storage Reservoir)</option>
            <option value="ESR">ESR (Elevated Storage Reservoir)</option>
          </select>
        </div>
        <div class="form-row">
          <label>Shape *</label>
          <select id="tankShape">
            <option value="cylinder">Cylindrical</option>
            <option value="cuboid">Cuboid/Rectangular</option>
            <option value="square">Square</option>
          </select>
        </div>
        <div class="form-row"><label>Capacity (L) *</label><input id="tankCapacity" type="number" placeholder="20000"/></div>
        <div class="form-row"><label>Current Water Level (m) *</label><input id="tankWaterLevel" type="number" step="0.1" placeholder="8.5"/></div>
        <div class="form-row"><label>Diameter/Length (m) *</label><input id="tankDiameter" type="number" step="0.1" placeholder="5.0"/></div>
        <div class="form-row"><label>Height (m) *</label><input id="tankHeight" type="number" step="0.1" placeholder="10.0"/></div>
        <div class="form-row"><label>Sensor Height (m) *</label><input id="tankSensorHeight" type="number" step="0.1" placeholder="10.0"/></div>
        <div class="form-row"><label>State</label><input id="tankState" placeholder="Telangana"/></div>
        <div class="form-row"><label>District</label><input id="tankDistrict" placeholder="Mulugu"/></div>
        <div class="form-row"><label>Mandal</label><input id="tankMandal" placeholder="Eturunagaram"/></div>
        <div class="form-row"><label>Habitation</label><input id="tankHabitation" placeholder="Ellishettypalle"/></div>
        <div class="form-row"><label>Latitude *</label><input id="tankLat" type="number" step="0.000001" placeholder="Right-click map"/></div>
        <div class="form-row"><label>Longitude *</label><input id="tankLng" type="number" step="0.000001" placeholder="Right-click map"/></div>
        <div class="form-row">
          <label>Active Status</label>
          <select id="tankIsActive">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
        <div class="modal-actions">
          <button id="saveTank" class="btn success"><i class="fas fa-save"></i> Save</button>
          <button class="btn" data-close="tankModal"><i class="fas fa-times"></i> Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Valve Modal -->
  <div class="modal" id="valveModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="valveModalTitle">Add Valve</h3>
        <button class="close-x" data-close="valveModal"><i class="fas fa-xmark"></i></button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <label>Valve ID * (Unique)</label>
          <input id="valveId" placeholder="VALVE-001" maxlength="50"/>
          <div class="error" id="valveIdError"></div>
        </div>
        <div class="form-row"><label>Name *</label><input id="valveName" placeholder="Main Gate Valve"/></div>
        <div class="form-row"><label>Type *</label>
          <select id="valveType">
            <option value="STRAIGHT">Straight</option>
            <option value="ELBOW">Elbow</option>
            <option value="TEE">Tee</option>
          </select>
        </div>
        <div class="form-row"><label>Category *</label>
          <select id="valveCategory">
            <option value="main">Main</option>
            <option value="sub">Sub</option>
          </select>
        </div>
        <div class="form-row" id="parentValveRow" style="display:none">
          <label>Parent Main Valve</label>
          <select id="parentValve"></select>
        </div>
        <div class="form-row"><label>Households *</label><input id="valveHouseholds" type="number" placeholder="10"/></div>
        <div class="form-row"><label>Flow Rate (L/min)</label><input id="valveFlowRate" type="number" placeholder="0" value="0"/></div>
        <div class="form-row"><label>Mandal</label><input id="valveMandal" placeholder="Eturunagaram"/></div>
        <div class="form-row"><label>Habitation</label><input id="valveHabitation" placeholder="Central Area"/></div>
        <div class="form-row"><label>Latitude *</label><input id="valveLat" type="number" step="0.000001" placeholder="Right-click map"/></div>
        <div class="form-row"><label>Longitude *</label><input id="valveLng" type="number" step="0.000001" placeholder="Right-click map"/></div>
        <div class="form-row">
          <label>Valve Status</label>
          <select id="valveIsOpen">
            <option value="true">Open</option>
            <option value="false">Closed</option>
          </select>
        </div>
        <div class="modal-actions">
          <button id="saveValve" class="btn success"><i class="fas fa-save"></i> Save</button>
          <button class="btn" data-close="valveModal"><i class="fas fa-times"></i> Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pipeline Modal -->
  <div class="modal" id="pipelineModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="pipelineModalTitle">Pipeline Details</h3>
        <button class="close-x" data-close="pipelineModal"><i class="fas fa-xmark"></i></button>
      </div>
      <div class="modal-body">
        <div class="form-row"><label>Name *</label><input id="pipelineName" placeholder="Main Supply Line"/></div>
        <div class="form-row"><label>Type *</label>
          <select id="pipelineType">
            <option value="PVC">PVC</option>
            <option value="HDPE">HDPE</option>
            <option value="DI">Ductile Iron</option>
          </select>
        </div>
        <div class="form-row"><label>Diameter (mm) *</label><input id="pipelineDiameter" type="number" placeholder="200"/></div>
        <div class="form-row"><label>Capacity (L/min) *</label><input id="pipelineCapacity" type="number" placeholder="800"/></div>
        <div class="form-row"><label>Start point</label><input id="pipelineStart" placeholder="Main Tank"/></div>
        <div class="form-row"><label>End point</label><input id="pipelineEnd" placeholder="Main Valve"/></div>
        <div class="form-row"><label>Notes</label><textarea id="pipelineNotes" placeholder="Optional notes"></textarea></div>
        <div class="modal-actions">
          <button id="savePipeline" class="btn success"><i class="fas fa-save"></i> Save</button>
          <button class="btn danger" id="deleteThisPipeline"><i class="fas fa-trash"></i> Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage Modal -->
  <div class="modal" id="manageModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Manage</h3>
        <button class="close-x" data-close="manageModal"><i class="fas fa-xmark"></i></button>
      </div>
      <div class="modal-body">
        <div class="tab-buttons">
          <button class="btn primary" data-tab="tanks"><i class="fas fa-water"></i> Tanks</button>
          <button class="btn" data-tab="valves"><i class="fas fa-cog"></i> Valves</button>
          <button class="btn" data-tab="pipelines"><i class="fas fa-pipe"></i> Pipelines</button>
          <button class="btn" data-tab="data"><i class="fas fa-database"></i> Data</button>
        </div>
        <div id="manageContent"></div>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div class="modal" id="historyModal">
    <div class="modal-content" style="max-width: 1200px;">
      <div class="modal-header">
        <h3 id="historyModalTitle">Device History</h3>
        <button class="close-x" data-close="historyModal"><i class="fas fa-xmark"></i></button>
      </div>
      <div class="modal-body">
        <div class="card" style="margin-bottom: 16px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; align-items: end;">
            <div class="form-row" style="margin-bottom: 0;">
              <label>Start Date</label>
              <input type="date" id="historyStartDate" style="padding: 11px 12px; border: 1px solid var(--line); border-radius: 10px; font-size: 13px;">
            </div>
            <div class="form-row" style="margin-bottom: 0;">
              <label>End Date</label>
              <input type="date" id="historyEndDate" style="padding: 11px 12px; border: 1px solid var(--line); border-radius: 10px; font-size: 13px;">
            </div>
            <button class="btn primary" id="filterHistoryBtn" style="margin: 0; height: 44px;">
              <i class="fas fa-filter"></i> Filter
            </button>
          </div>
        </div>
        
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h4 style="margin: 0;"><i class="fas fa-clock-rotate-left"></i> HISTORICAL DATA</h4>
            <button class="btn success" id="exportHistoryBtn" style="margin: 0;">
              <i class="fas fa-download"></i> Export CSV
            </button>
          </div>
          <div id="historyContent" style="max-height: 500px; overflow-y: auto;">
            <div style="text-align: center; padding: 40px; color: var(--muted);">
              <i class="fas fa-spinner fa-spin" style="font-size: 32px;"></i>
              <div style="margin-top: 12px;">Loading history...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <input id="importFile" type="file" accept=".json" style="display:none"/>
  <div id="toast" class="toast"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>
  <script>
    // ==================== API SERVICE ====================
    const APIService = {
      baseURL: 'http://localhost:3000/api',
      
      async request(endpoint, options = {}) {
        try {
          const response = await fetch(`${this.baseURL}${endpoint}`, {
            headers: {
              'Content-Type': 'application/json',
              ...options.headers
            },
            ...options
          });
          
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || `HTTP ${response.status}`);
          }
          
          return await response.json();
        } catch (error) {
          console.error('API Request Error:', error);
          throw error;
        }
      },
      
      // Tank Endpoints
      async getTanks() {
        return this.request('/tanks');
      },
      
      async getTank(tankId) {
        return this.request(`/tank/${tankId}`);
      },
      
      async createTank(tankData) {
        return this.request('/tank', {
          method: 'POST',
          body: JSON.stringify(tankData)
        });
      },
      
      async updateTank(tankId, tankData) {
        return this.request(`/tank/${tankId}`, {
          method: 'PUT',
          body: JSON.stringify(tankData)
        });
      },
      
      async deleteTank(tankId) {
        return this.request(`/tank/${tankId}`, {
          method: 'DELETE'
        });
      },
      
      async toggleTank(tankId, isActive) {
        return this.updateTank(tankId, { isActive });
      },
      
      // Valve Endpoints
      async getValves() {
        return this.request('/valves');
      },
      
      async getValve(valveId) {
        return this.request(`/valve/${valveId}`);
      },
      
      async createValve(valveData) {
        return this.request('/valve', {
          method: 'POST',
          body: JSON.stringify(valveData)
        });
      },
      
      async updateValve(valveId, valveData) {
        return this.request(`/valve/${valveId}`, {
          method: 'PUT',
          body: JSON.stringify(valveData)
        });
      },
      
      async deleteValve(valveId) {
        return this.request(`/valve/${valveId}`, {
          method: 'DELETE'
        });
      },
      
      async toggleValve(valveId, isOpen) {
        return this.request(`/valve/${valveId}/toggle`, {
          method: 'PATCH'
        });
      },
      
      // Pipeline Endpoints
      async getPipelines() {
        return this.request('/pipelines');
      },
      
      async getPipeline(pipelineId) {
        return this.request(`/pipeline/${pipelineId}`);
      },
      
      async createPipeline(pipelineData) {
        return this.request('/pipeline', {
          method: 'POST',
          body: JSON.stringify(pipelineData)
        });
      },
      
      async updatePipeline(pipelineId, pipelineData) {
        return this.request(`/pipeline/${pipelineId}`, {
          method: 'PUT',
          body: JSON.stringify(pipelineData)
        });
      },
      
      async deletePipeline(pipelineId) {
        return this.request(`/pipeline/${pipelineId}`, {
          method: 'DELETE'
        });
      },
      
      // History Endpoints
      async getHistory(deviceId, deviceType) {
        return this.request(`/history/${deviceId}?type=${deviceType}`);
      },
      
      async getHistoryRange(deviceId, deviceType, start, end) {
        return this.request(`/history/${deviceId}/range?type=${deviceType}&start=${start}&end=${end}`);
      },
      
      async getLatestHistory(deviceId, deviceType) {
        return this.request(`/history/${deviceId}/latest?type=${deviceType}`);
      },
      
      // System Endpoints
      async pollAll() {
        return this.request('/poll/all');
      },
      
      async getFlowData() {
        return this.request('/flow/calculate');
      },
      
      async getSupplyOverview() {
        return this.request('/supply/overview');
      },
      
      // Sensor Data Endpoints
      async getSensorData(deviceId) {
        return this.request(`/sensor/${deviceId}`);
      },
      
      async getLiveSensorData(deviceId) {
        return this.request(`/sensor/${deviceId}/live`);
      },
      
      // Data Import/Export
      async exportData() {
        const response = await fetch(`${this.baseURL}/export/all`);
        return await response.json();
      },
      
      async importData(data) {
        return this.request('/import', {
          method: 'POST',
          body: JSON.stringify(data)
        });
      }
    };



    // ==================== FIREBASE INITIALIZATION ====================
let firebaseApp = null;
let firebaseDb = null;
const firebaseListeners = new Map();

const firebaseConfig = {
  databaseURL: "https://jal-mahakal-shakti-default-rtdb.asia-southeast1.firebasedatabase.app"
};

// Initialize Firebase
try {
  firebaseApp = firebase.initializeApp(firebaseConfig);
  firebaseDb = firebase.database();
  console.log('✅ Firebase initialized for real-time tank monitoring');
} catch (error) {
  console.error('❌ Firebase initialization failed:', error);
  console.log('⚠️ Continuing without Firebase real-time updates');
}

    // ==================== GLOBAL STATE ====================
    let map, canvas, ctx;
    let currentLayer = null;
    let mapLayers = {};
    let tanks = [], valves = [], pipelines = [];
    let mode = 'pipeline';
    let isDrawing = false, currentPipeline = [];
    let hoveredDevice = null;
    let isConnected = false;
    let supplyDashboardCollapsed = false;
    let flowData = null;
    let supplyData = null;

    const POINT_R = 10;
    const LINE_W = 4;
    const CONNECT_THRESH = 18;
    const CLICK_DETECT_RADIUS = 15;
    const DRAW_THROTTLE = 16;

    // ==================== UTILITY FUNCTIONS ====================
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      };
    }

    function throttle(func, limit) {
      let inThrottle = false;
      return function(...args) {
        if (!inThrottle) {
          func.apply(this, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      };
    }

    function updateConnectionStatus(connected) {
      isConnected = connected;
      const statusEl = document.getElementById('connectionStatus');
      const textEl = document.getElementById('statusText');
      if(connected) {
        statusEl.className = 'connection-status connected';
        textEl.textContent = 'Connected';
      } else {
        statusEl.className = 'connection-status disconnected';
        textEl.textContent = 'Disconnected';
      }
    }

    function showLoading(show) {
      document.getElementById('loadingOverlay').classList.toggle('active', show);
    }

    function toast(message) {
      const toastEl = document.getElementById('toast');
      toastEl.textContent = message;
      toastEl.style.display = 'block';
      setTimeout(() => toastEl.style.display = 'none', 3000);
    }

    function setActive(id, active) {
      const el = document.getElementById(id);
      if(el) el.classList.toggle('active', active);
    }

    function setText(id, text) {
      const el = document.getElementById(id);
      if(el) el.textContent = text;
    }

    function setValue(id, value) {
      const el = document.getElementById(id);
      if(el) el.value = value;
    }

    function val(id) {
      const el = document.getElementById(id);
      return el ? el.value : '';
    }

    function openModal(id) {
      const el = document.getElementById(id);
      if(el) el.classList.add('active');
    }

    function closeModal(id) {
      const el = document.getElementById(id);
      if(el) el.classList.remove('active');
    }

    function bindBtn(id, fn) {
      const el = document.getElementById(id);
      if(el) el.addEventListener('click', fn);
    }

    // ==================== MAP FUNCTIONS ====================
    function initMap() {
      try {
        map = L.map('map', {
          zoomControl: false,
          minZoom: 2,
          maxZoom: 19,
          preferCanvas: true,
          zoomAnimation: true,
          fadeAnimation: true
        }).setView([17.9689, 79.5941], 13);

        mapLayers = {
          street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
          }),
          
          satellite: L.tileLayer('http://mt{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['0','1','2','3'],
            attribution: '© Google'
          }),
          
          dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            subdomains: 'abcd',
            attribution: '© CARTO'
          })
        };

        currentLayer = mapLayers.street;
        currentLayer.addTo(map);
        
        currentLayer.on('tileerror', function(error) {
          console.warn('Tile loading error:', error);
        });

        const debouncedDraw = debounce(requestDrawCanvas, 100);
        map.on('move', debouncedDraw);
        map.on('zoom', debouncedDraw);
        map.on('moveend', requestDrawCanvas);
        map.on('zoomend', requestDrawCanvas);
        map.on('contextmenu', onMapRightClick);
        map.on('click', onMapClick);
        
      } catch(error) {
        console.error('Error initializing map:', error);
        toast('⚠️ Map initialization failed');
      }
    }

    function switchMapLayer(layerName) {
      if(!mapLayers[layerName]) return;
      
      if(currentLayer) {
        try {
          map.removeLayer(currentLayer);
        } catch(e) {
          console.error('Error removing layer:', e);
        }
      }
      
      currentLayer = mapLayers[layerName];
      
      try {
        currentLayer.addTo(map);
      } catch(e) {
        console.error('Error adding layer:', e);
        return;
      }
      
      document.querySelectorAll('.layer').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`layer${layerName.charAt(0).toUpperCase() + layerName.slice(1)}`).classList.add('active');
      
      toast(`✓ ${layerName.charAt(0).toUpperCase() + layerName.slice(1)} view`);
      requestDrawCanvas();
    }

    // ==================== CANVAS FUNCTIONS ====================
    function initCanvas() {
      canvas = document.getElementById('canvas');
      ctx = canvas.getContext('2d', { alpha: true, desynchronized: true });
      resizeCanvas();
      window.addEventListener('resize', debounce(resizeCanvas, 250));

      canvas.addEventListener('mousedown', handleCanvasMouseDown);
      canvas.addEventListener('mousemove', throttle(handleCanvasMouseMove, 16));
      canvas.addEventListener('mouseup', handleCanvasMouseUp);
      canvas.addEventListener('mouseleave', handleCanvasMouseUp);
    }

    function resizeCanvas() {
      const rect = map.getContainer().getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
      requestDrawCanvas();
    }

    function eventToPixel(e) {
      const rect = canvas.getBoundingClientRect();
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }

    function pixelToLatLng(pixel) {
      const point = map.containerPointToLatLng([pixel.x, pixel.y]);
      return {lat: point.lat, lng: point.lng};
    }

    function latLngToPixel(latLng) {
  // Validate input
  if (!latLng || typeof latLng.lat !== 'number' || typeof latLng.lng !== 'number') {
    console.error('Invalid latLng in latLngToPixel:', latLng);
    return { x: 0, y: 0 }; // Return origin for invalid coordinates
  }
  
  const point = map.latLngToContainerPoint([latLng.lat, latLng.lng]);
  return {x: point.x, y: point.y};
}

    function distanceBetweenPixels(p1, p2) {
      return Math.hypot(p2.x - p1.x, p2.y - p1.y);
    }

    function distanceInPixels(device, latLng2) {
  // Handle both device objects and coordinate objects
  let latLng1;
  
  if (device.latitude !== undefined && device.longitude !== undefined) {
    // It's a device object (tank/valve)
    latLng1 = { lat: device.latitude, lng: device.longitude };
  } else if (device.lat !== undefined && device.lng !== undefined) {
    // It's already a coordinate object
    latLng1 = device;
  } else {
    console.warn('Invalid device/coordinates in distanceInPixels:', device);
    return Infinity;
  }
  
  // Validate both coordinates
  if (!latLng1 || !latLng2 || 
      typeof latLng1.lat !== 'number' || typeof latLng1.lng !== 'number' ||
      typeof latLng2.lat !== 'number' || typeof latLng2.lng !== 'number' ||
      isNaN(latLng1.lat) || isNaN(latLng1.lng) ||
      isNaN(latLng2.lat) || isNaN(latLng2.lng)) {
    console.warn('Invalid coordinates in distanceInPixels:', latLng1, latLng2);
    return Infinity;
  }
  
  const p1 = latLngToPixel(latLng1);
  const p2 = latLngToPixel(latLng2);
  return distanceBetweenPixels(p1, p2);
}

    // ==================== MODE CONTROL ====================
    function setMode(m) {
      mode = m;
      updateToolbar();
      if(m === 'pipeline' || m === 'erase') {
        canvas.classList.add('active');
        canvas.classList.remove('drawing');
        map.dragging.disable();
        map.scrollWheelZoom.disable();
      } else {
        canvas.classList.remove('active', 'drawing');
        map.dragging.enable();
        map.scrollWheelZoom.enable();
      }
    }

    function updateToolbar() {
      setActive('toolPipeline', mode === 'pipeline');
      setActive('toolTank', mode === 'tank');
      setActive('toolValve', mode === 'valve');
      setActive('toolErase', mode === 'erase');
    }

    // ==================== HOVER TOOLTIPS ====================
    function showHoverTooltip(content, x, y) {
      const tooltip = document.getElementById('hoverTooltip');
      tooltip.innerHTML = content;
      tooltip.style.left = `${x + 10}px`;
      tooltip.style.top = `${y + 10}px`;
      tooltip.classList.add('active');
    }

    function hideHoverTooltip() {
      const tooltip = document.getElementById('hoverTooltip');
      tooltip.classList.remove('active');
    }

    // ==================== MAP INTERACTIONS ====================
    function onMapClick(e) {
  const latLng = e.latlng;
  if(mode === 'erase') return;
  
  // Check if clicked on tank with validation
  const clickedTank = tanks.find(t => {
    if (!t || typeof t.latitude !== 'number' || typeof t.longitude !== 'number') {
      return false;
    }
    // Pass the tank object directly - distanceInPixels will handle it
    return distanceInPixels(t, latLng) < CLICK_DETECT_RADIUS;
  });
  
  if(clickedTank) {
    showDevice(clickedTank, 'tank');
    return;
  }
  
  // Check if clicked on valve with validation
  const clickedValve = valves.find(v => {
    if (!v || typeof v.latitude !== 'number' || typeof v.longitude !== 'number') {
      return false;
    }
    // Pass the valve object directly - distanceInPixels will handle it
    return distanceInPixels(v, latLng) < CLICK_DETECT_RADIUS;
  });
  
  if(clickedValve) {
    showDevice(clickedValve, 'valve');
    return;
  }

  if(mode === 'tank') {
    openModal('tankModal');
    setText('tankModalTitle', 'Add Tank');
    setValue('tankLat', latLng.lat.toFixed(6));
    setValue('tankLng', latLng.lng.toFixed(6));
    setValue('tankId', 'TANK-' + Date.now().toString().slice(-6));
    setValue('tankWaterLevel', '8.5');
    setValue('tankDiameter', '5.0');
    setValue('tankHeight', '10.0');
    setValue('tankSensorHeight', '10.0');
    setValue('tankCapacity', '20000');
    document.getElementById('tankModal').removeAttribute('data-edit-id');
    document.getElementById('tankIdError').textContent = '';
  } else if(mode === 'valve') {
    openModal('valveModal');
    setText('valveModalTitle', 'Add Valve');
    setValue('valveLat', latLng.lat.toFixed(6));
    setValue('valveLng', latLng.lng.toFixed(6));
    setValue('valveId', 'VALVE-' + Date.now().toString().slice(-6));
    setValue('valveCategory', 'sub');
    setValue('valveHouseholds', '10');
    setValue('valveFlowRate', '0');
    document.getElementById('parentValveRow').style.display = 'block';
    updateParentValveList();
    document.getElementById('valveModal').removeAttribute('data-edit-id');
    document.getElementById('valveIdError').textContent = '';
  }
}

    function onMapRightClick(e) {
      e.originalEvent.preventDefault();
      const {lat, lng} = e.latlng;
      setValue('tankLat', lat.toFixed(6));
      setValue('tankLng', lng.toFixed(6));
      setValue('valveLat', lat.toFixed(6));
      setValue('valveLng', lng.toFixed(6));
      toast('📍 Coordinates filled');
    }

    // ==================== CANVAS INTERACTIONS ====================
    function handleCanvasMouseDown(e) {
      if(mode !== 'pipeline') return;
      e.preventDefault();
      e.stopPropagation();
      const latLng = pixelToLatLng(eventToPixel(e));
      isDrawing = true;
      currentPipeline = [latLng];
      canvas.classList.add('drawing');
    }

    function handleCanvasMouseMove(e) {
  const px = eventToPixel(e);
  const latLng = pixelToLatLng(px);
  
  // Handle hover with validation
  const hoveredTank = tanks.find(t => {
    if (!t || typeof t.latitude !== 'number' || typeof t.longitude !== 'number') {
      return false;
    }
    // Pass the tank object directly - distanceInPixels will handle it
    return distanceInPixels(t, latLng) < CLICK_DETECT_RADIUS;
  });
  
  const hoveredValve = valves.find(v => {
    if (!v || typeof v.latitude !== 'number' || typeof v.longitude !== 'number') {
      return false;
    }
    // Pass the valve object directly - distanceInPixels will handle it
    return distanceInPixels(v, latLng) < CLICK_DETECT_RADIUS;
  });
  
  hoveredDevice = hoveredTank ? {type:'tank', device:hoveredTank} : 
                  hoveredValve ? {type:'valve', device:hoveredValve} : null;
  
  // Show tooltip for hovered device
  if (hoveredDevice) {
    const tooltipContent = createTooltipContent(hoveredDevice.device, hoveredDevice.type);
    showHoverTooltip(tooltipContent, e.clientX, e.clientY);
  } else {
    hideHoverTooltip();
  }
  
  if(isDrawing && mode === 'pipeline') {
    e.preventDefault();
    const lastLatLng = currentPipeline[currentPipeline.length-1];
    const lastPx = latLngToPixel(lastLatLng);
    if(distanceBetweenPixels(lastPx, px) > 3) {
      currentPipeline.push(latLng);
      requestDrawCanvas();
    }
  }
}

    async function handleCanvasMouseUp(e) {
      if(!isDrawing) return;
      e.preventDefault();
      e.stopPropagation();
      
      if(currentPipeline.length > 2) {
        try {
          const pipelineData = {
            name: `Pipeline ${new Date().toLocaleTimeString()}`,
            type: 'PVC',
            diameter: 150,
            capacity: 500,
            nodes: currentPipeline
          };
          
          await APIService.createPipeline(pipelineData);
          toast('✓ Pipeline created!');
          await loadPipelines();
        } catch (error) {
          toast('❌ Failed to save pipeline');
        }
      } else {
        toast('⚠️ Pipeline too short');
      }
      
      currentPipeline = [];
      isDrawing = false;
      canvas.classList.remove('drawing');
      map.dragging.enable();
      map.scrollWheelZoom.enable();
      requestDrawCanvas();
    }

    // ==================== TOOLTIP CONTENT ====================
    function createTooltipContent(device, type) {
      if (type === 'tank') {
        return `
          <div class="tooltip-title">
            <i class="fas fa-water"></i> ${device.name}
            <span class="status-indicator ${device.isActive ? 'status-active' : 'status-inactive'}"></span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Type:</span>
            <span class="tooltip-value">${device.type}</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Capacity:</span>
            <span class="tooltip-value">${device.capacity} L</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Water Level:</span>
            <span class="tooltip-value">${device.waterLevel} m</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Status:</span>
            <span class="tooltip-value">${device.isActive ? 'Active' : 'Inactive'}</span>
          </div>
        `;
      } else if (type === 'valve') {
        return `
          <div class="tooltip-title">
            <i class="fas fa-cog"></i> ${device.name}
            <span class="status-indicator ${device.isOpen ? 'status-active' : 'status-inactive'}"></span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Type:</span>
            <span class="tooltip-value">${device.type}</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Category:</span>
            <span class="tooltip-value">${device.category.toUpperCase()}</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Status:</span>
            <span class="tooltip-value">${device.isOpen ? 'OPEN' : 'CLOSED'}</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Households:</span>
            <span class="tooltip-value">${device.households}</span>
          </div>
        `;
      }
      return '';
    }

    // ==================== DATA LOADING ====================
    async function loadTanks() {
  try {
    const rawTanks = await APIService.getTanks();
    
    // Validate and filter tanks
    tanks = rawTanks.filter(tank => {
      if (!tank) {
        console.warn('Null tank found');
        return false;
      }
      
      if (typeof tank.latitude !== 'number' || typeof tank.longitude !== 'number') {
        console.warn('Invalid tank coordinates:', tank);
        return false;
      }
      
      if (isNaN(tank.latitude) || isNaN(tank.longitude)) {
        console.warn('NaN coordinates in tank:', tank);
        return false;
      }
      
      return true;
    });
    
    console.log(`✅ Loaded ${tanks.length} valid tanks`);
    requestDrawCanvas();
    return true;
  } catch (error) {
    console.error('Error loading tanks:', error);
    toast('❌ Failed to load tanks');
    return false;
  }
}

async function loadValves() {
  try {
    const rawValves = await APIService.getValves();
    
    // Validate and filter valves
    valves = rawValves.filter(valve => {
      if (!valve) {
        console.warn('Null valve found');
        return false;
      }
      
      if (typeof valve.latitude !== 'number' || typeof valve.longitude !== 'number') {
        console.warn('Invalid valve coordinates:', valve);
        return false;
      }
      
      if (isNaN(valve.latitude) || isNaN(valve.longitude)) {
        console.warn('NaN coordinates in valve:', valve);
        return false;
      }
      
      return true;
    });
    
    console.log(`✅ Loaded ${valves.length} valid valves`);
    requestDrawCanvas();
    return true;
  } catch (error) {
    console.error('Error loading valves:', error);
    toast('❌ Failed to load valves');
    return false;
  }
}

async function loadPipelines() {
  try {
    const rawPipelines = await APIService.getPipelines();
    
    // Validate and filter pipelines
    pipelines = rawPipelines.filter(pipeline => {
      if (!pipeline) {
        console.warn('Null pipeline found');
        return false;
      }
      
      if (!pipeline.nodes || !Array.isArray(pipeline.nodes) || pipeline.nodes.length === 0) {
        console.warn('Invalid pipeline nodes:', pipeline);
        return false;
      }
      
      // Validate all nodes
      const hasValidNodes = pipeline.nodes.every(node => 
        node && 
        typeof node.lat === 'number' && 
        typeof node.lng === 'number' &&
        !isNaN(node.lat) && 
        !isNaN(node.lng)
      );
      
      if (!hasValidNodes) {
        console.warn('Pipeline has invalid nodes:', pipeline);
        return false;
      }
      
      return true;
    });
    
    console.log(`✅ Loaded ${pipelines.length} valid pipelines`);
    requestDrawCanvas();
    return true;
  } catch (error) {
    console.error('Error loading pipelines:', error);
    toast('❌ Failed to load pipelines');
    return false;
  }
}




    async function loadFlowData() {
      try {
        flowData = await APIService.getFlowData();
        return true;
      } catch (error) {
        console.error('Error loading flow data:', error);
        return false;
      }
    }

    async function loadSupplyOverview() {
      try {
        supplyData = await APIService.getSupplyOverview();
        updateSupplyDashboard();
        return true;
      } catch (error) {
        console.error('Error loading supply overview:', error);
        return false;
      }
    }

    async function loadAllData() {
      showLoading(true);
      
      const promises = [
        loadTanks(),
        loadValves(),
        loadPipelines(),
        loadFlowData(),
        loadSupplyOverview()
      ];
      
      try {
        await Promise.all(promises);
        updateConnectionStatus(true);
        showLoading(false);
      } catch (error) {
        updateConnectionStatus(false);
        showLoading(false);
        toast('⚠️ Failed to load some data');
      }
    }

    // ==================== CRUD OPERATIONS ====================
    async function onSaveTank() {
      const tankData = {
        tankId: val('tankId').trim(),
        deviceId: val('tankDeviceId').trim() || null,
        name: val('tankName').trim(),
        type: val('tankType'),
        shape: val('tankShape'),
        capacity: parseFloat(val('tankCapacity')),
        waterLevel: parseFloat(val('tankWaterLevel')),
        diameter: parseFloat(val('tankDiameter')),
        height: parseFloat(val('tankHeight')),
        sensorHeight: parseFloat(val('tankSensorHeight')),
        state: val('tankState').trim(),
        district: val('tankDistrict').trim(),
        mandal: val('tankMandal').trim(),
        habitation: val('tankHabitation').trim(),
        latitude: parseFloat(val('tankLat')),
        longitude: parseFloat(val('tankLng')),
        isActive: val('tankIsActive') === 'true'
      };

      const editingId = document.getElementById('tankModal').getAttribute('data-edit-id');
      
      try {
        if (editingId) {
          await APIService.updateTank(editingId, tankData);
          toast('✓ Tank updated');
        } else {
          await APIService.createTank(tankData);
          toast('✓ Tank added');
        }
        
        await loadTanks();
        await loadFlowData();
        await loadSupplyOverview();
        closeModal('tankModal');
        setMode('pipeline');
      } catch (error) {
        toast('❌ Failed to save tank');
      }
    }

    async function onSaveValve() {
      const valveData = {
        valveId: val('valveId').trim(),
        name: val('valveName').trim(),
        type: val('valveType'),
        category: val('valveCategory'),
        parentValveId: val('valveCategory') === 'sub' ? val('parentValve') : null,
        households: parseInt(val('valveHouseholds')),
        flowRate: parseFloat(val('valveFlowRate')) || 0,
        mandal: val('valveMandal').trim(),
        habitation: val('valveHabitation').trim(),
        latitude: parseFloat(val('valveLat')),
        longitude: parseFloat(val('valveLng')),
        isOpen: val('valveIsOpen') === 'true'
      };

      const editingId = document.getElementById('valveModal').getAttribute('data-edit-id');
      
      try {
        if (editingId) {
          await APIService.updateValve(editingId, valveData);
          toast('✓ Valve updated');
        } else {
          await APIService.createValve(valveData);
          toast('✓ Valve added');
        }
        
        await loadValves();
        await loadFlowData();
        await loadSupplyOverview();
        closeModal('valveModal');
        setMode('pipeline');
      } catch (error) {
        toast('❌ Failed to save valve');
      }
    }

    async function onSavePipeline() {
      const pipelineId = document.getElementById('pipelineModal').getAttribute('data-pipe-id');
      const pipelineData = {
        name: val('pipelineName').trim(),
        type: val('pipelineType'),
        diameter: parseFloat(val('pipelineDiameter')),
        capacity: parseFloat(val('pipelineCapacity')),
        startPoint: val('pipelineStart').trim(),
        endPoint: val('pipelineEnd').trim(),
        notes: val('pipelineNotes').trim()
      };

      try {
        if (pipelineId) {
          await APIService.updatePipeline(pipelineId, pipelineData);
          toast('✓ Pipeline updated');
        }
        
        await loadPipelines();
        await loadFlowData();
        await loadSupplyOverview();
        closeModal('pipelineModal');
      } catch (error) {
        toast('❌ Failed to save pipeline');
      }
    }

    async function deleteTank(tankId) {
      if (!confirm('Delete this tank?')) return;
      
      try {
        await APIService.deleteTank(tankId);
        await loadTanks();
        await loadFlowData();
        await loadSupplyOverview();
        toast('✓ Tank deleted');
        closeSidebar();
      } catch (error) {
        toast('❌ Failed to delete tank');
      }
    }

    async function deleteValve(valveId) {
      if (!confirm('Delete this valve?')) return;
      
      try {
        await APIService.deleteValve(valveId);
        await loadValves();
        await loadFlowData();
        await loadSupplyOverview();
        toast('✓ Valve deleted');
        closeSidebar();
      } catch (error) {
        toast('❌ Failed to delete valve');
      }
    }

    async function deletePipeline(pipelineId) {
      if (!confirm('Delete this pipeline?')) return;
      
      try {
        await APIService.deletePipeline(pipelineId);
        await loadPipelines();
        await loadFlowData();
        await loadSupplyOverview();
        toast('✓ Pipeline deleted');
        closeModal('pipelineModal');
      } catch (error) {
        toast('❌ Failed to delete pipeline');
      }
    }

    async function toggleValve(valveId, isOpen) {
      try {
        await APIService.toggleValve(valveId, isOpen);
        await loadValves();
        await loadFlowData();
        await loadSupplyOverview();
        toast(`✓ Valve ${isOpen ? 'opened' : 'closed'}`);
      } catch (error) {
        toast('❌ Failed to toggle valve');
      }
    }

    async function toggleTank(tankId, isActive) {
      try {
        await APIService.toggleTank(tankId, isActive);
        await loadTanks();
        await loadFlowData();
        await loadSupplyOverview();
        toast(`✓ Tank ${isActive ? 'activated' : 'deactivated'}`);
      } catch (error) {
        toast('❌ Failed to toggle tank');
      }
    }

    // ==================== SIDEBAR FUNCTIONS ====================
    async function showDevice(device, type) {
  const sidebar = document.getElementById('sidebar');
  const body = document.getElementById('sidebarBody');
  
  try {
    let deviceDetails;
    let sensorData = null;
    
    if (type === 'tank') {
      deviceDetails = await APIService.getTank(device.tankId);
      
      // Start Firebase listener for real-time updates
      if (deviceDetails.deviceId && firebaseDb) {
        console.log(`🔥 Starting Firebase listener for tank ${deviceDetails.tankId} (device: ${deviceDetails.deviceId})`);
        
        // Stop any existing listeners
        firebaseListeners.forEach((listener, deviceId) => {
          firebase.database().ref(`tanks/${deviceId}`).off('value', listener);
        });
        firebaseListeners.clear();
        
        // Start new listener
        const tankRef = firebase.database().ref(`tanks/${deviceDetails.deviceId}`);
        const listener = tankRef.on('value', (snapshot) => {
          const liveData = snapshot.val();
          if (liveData) {
            console.log('📊 Live data received:', liveData);
            // Update the sidebar immediately with live data
            updateSidebarWithLiveData(deviceDetails, liveData);
          }
        });
        
        firebaseListeners.set(deviceDetails.deviceId, listener);
        
        // Also get initial data from API
        try {
          sensorData = await APIService.getLiveSensorData(deviceDetails.deviceId);
          console.log('📡 Initial sensor data loaded:', sensorData);
        } catch (error) {
          console.log('ℹ️ No cached sensor data, waiting for Firebase...');
        }
      }
      
      body.innerHTML = generateTankSidebarContent(deviceDetails, sensorData);
      
      // Add water level slider listener AFTER content is generated
      const waterLevelSlider = document.getElementById('waterLevelSlider');
      if (waterLevelSlider) {
        waterLevelSlider.addEventListener('input', (e) => {
          const newLevel = parseFloat(e.target.value);
          const waterFill = document.getElementById('waterFill');
          const waterLevelDisplay = document.getElementById('waterLevelDisplay');
          
          if (waterFill && deviceDetails.height) {
            const percentage = (newLevel / deviceDetails.height) * 100;
            waterFill.style.height = `${percentage}%`;
            waterFill.textContent = `${newLevel.toFixed(1)} m`;
          }
          
          if (waterLevelDisplay) {
            waterLevelDisplay.textContent = `${newLevel.toFixed(1)} m`;
          }
        });
      }
      
    } else {
      deviceDetails = await APIService.getValve(device.valveId);
      body.innerHTML = generateValveSidebarContent(deviceDetails);
    }
    
    sidebar.classList.add('open');
  } catch (error) {
    console.error('Error loading device details:', error);
    toast('❌ Failed to load device details');
  }
}


function updateSidebarWithLiveData(tank, liveData) {
  // Check if sidebar is still showing this tank
  const sidebarTitle = document.getElementById('sidebarTitle');
  if (!sidebarTitle) return;
  
  console.log('🔄 Updating sidebar with live data:', liveData);
  
  // Find the sensor data card
  const cards = document.querySelectorAll('.card');
  let sensorCardElement = null;
  
  cards.forEach(card => {
    const header = card.querySelector('h4');
    if (header && header.textContent.includes('LIVE SENSOR DATA')) {
      sensorCardElement = card;
    }
  });
  
  if (!sensorCardElement) {
    console.warn('⚠️ Sensor card not found in sidebar');
    return;
  }
  
  // Determine status color and icon
  let statusColor, statusIcon, statusBg;
  switch(liveData.status?.toLowerCase()) {
    case 'filling':
      statusColor = '#2e7d32';
      statusIcon = '⬆️';
      statusBg = '#e8f5e9';
      break;
    case 'draining':
      statusColor = '#f57c00';
      statusIcon = '⬇️';
      statusBg = '#fff3e0';
      break;
    case 'critical':
      statusColor = '#c62828';
      statusIcon = '🚨';
      statusBg = '#ffebee';
      break;
    case 'low':
      statusColor = '#f57c00';
      statusIcon = '⚠️';
      statusBg = '#fff3e0';
      break;
    case 'high':
      statusColor = '#1976d2';
      statusIcon = '💧';
      statusBg = '#e3f2fd';
      break;
    default:
      statusColor = '#2e7d32';
      statusIcon = '✓';
      statusBg = '#e8f5e9';
  }
  
  // Flow status badge
  let flowBadge = '';
  if (liveData.flowRate !== undefined && liveData.flowRate !== 0) {
    const flowColor = liveData.flowRate > 0 ? '#2e7d32' : '#f57c00';
    const flowIcon = liveData.flowRate > 0 ? '⬆️' : '⬇️';
    const flowText = liveData.flowRate > 0 ? 'INFLOW' : 'OUTFLOW';
    flowBadge = `
      <div style="margin-top:12px;padding:10px;background:${liveData.flowRate > 0 ? '#e8f5e9' : '#fff3e0'};border-radius:8px;text-align:center;">
        <div style="font-size:11px;color:#666;margin-bottom:4px;">${flowIcon} ${flowText}</div>
        <div style="font-size:20px;font-weight:700;color:${flowColor};">${Math.abs(liveData.flowRate).toFixed(1)} L/min</div>
      </div>
    `;
  }
  
  const timestamp = new Date().toLocaleTimeString();
  
  // Update card with enhanced styling
  sensorCardElement.innerHTML = `
    <h4>
      <i class="fas fa-satellite-dish"></i> LIVE SENSOR DATA 
      <span class="live-indicator"></span>
      <span style="font-size:10px;color:#4caf50;margin-left:8px">🔥 LIVE</span>
    </h4>
    <div class="row">
      <span class="label">Water Level</span>
      <span class="value">${liveData.waterLevel?.toFixed(2) || 0} m</span>
    </div>
    <div class="row">
      <span class="label">Fill Percentage</span>
      <span class="value">${liveData.percentage?.toFixed(1) || 0}%</span>
    </div>
    <div class="row">
      <span class="label">Volume</span>
      <span class="value">${liveData.volume?.toFixed(0) || 0} L</span>
    </div>
    <div class="row">
      <span class="label">Pressure</span>
      <span class="value">${liveData.pressure?.toFixed(2) || 0} kPa</span>
    </div>
    <div class="row">
      <span class="label">Weight</span>
      <span class="value">${liveData.weight?.toFixed(0) || 0} kg</span>
    </div>
    ${flowBadge}
    <div style="margin-top:12px;padding:12px;background:${statusBg};border-radius:8px;border-left:4px solid ${statusColor};">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <span style="font-weight:600;color:#333;">Status</span>
        <span style="font-weight:700;color:${statusColor};font-size:14px;">
          ${statusIcon} ${(liveData.status || 'UNKNOWN').toUpperCase()}
        </span>
      </div>
    </div>
    <div class="row" style="margin-top:8px;">
      <span class="label">Last Update</span>
      <span class="value" style="font-size:11px;color:#666;">${timestamp}</span>
    </div>
  `;
  
  // Update water level visualization
  const waterLevelSlider = document.getElementById('waterLevelSlider');
  const waterLevelDisplay = document.getElementById('waterLevelDisplay');
  const waterFill = document.getElementById('waterFill');
  
  if (waterLevelSlider && liveData.waterLevel !== undefined) {
    waterLevelSlider.value = liveData.waterLevel;
    console.log('🎚️ Updated slider to:', liveData.waterLevel);
  }
  
  if (waterLevelDisplay) {
    waterLevelDisplay.textContent = `${liveData.waterLevel?.toFixed(1) || 0} m`;
  }
  
  if (waterFill && liveData.percentage !== undefined) {
    // Animate the water fill
    waterFill.style.transition = 'height 0.5s ease';
    waterFill.style.height = `${liveData.percentage}%`;
    waterFill.textContent = `${liveData.waterLevel?.toFixed(1) || 0} m`;
    
    // Change water color based on status
    if (liveData.status === 'filling') {
      waterFill.style.background = 'linear-gradient(180deg, #66bb6a 0%, #43a047 100%)';
    } else if (liveData.status === 'draining' || liveData.status === 'low') {
      waterFill.style.background = 'linear-gradient(180deg, #ffa726 0%, #fb8c00 100%)';
    } else if (liveData.status === 'critical') {
      waterFill.style.background = 'linear-gradient(180deg, #ef5350 0%, #e53935 100%)';
    } else {
      waterFill.style.background = 'linear-gradient(180deg, #03a9f4 0%, #0288d1 100%)';
    }
    
    console.log('💧 Updated water fill to:', liveData.percentage + '%');
  }
  
  console.log('✅ Sidebar updated successfully with live data and flow rate');
}

    function generateTankSidebarContent(tank, sensorData) {
  const hasSensorData = sensorData && sensorData.waterLevel !== undefined;
  const displayWaterLevel = hasSensorData ? sensorData.waterLevel : tank.waterLevel;
  const displayPercentage = hasSensorData ? sensorData.percentage : ((tank.waterLevel / tank.height) * 100);
  
  return `
    <div class="card">
      <h4><i class="fas fa-info-circle"></i> DETAILS</h4>
      <div class="row"><span class="label">ID</span><span class="value">${tank.tankId}</span></div>
      <div class="row"><span class="label">Device ID</span><span class="value">${tank.deviceId || 'Not linked'}</span></div>
      <div class="row"><span class="label">Name</span><span class="value">${tank.name}</span></div>
      <div class="row"><span class="label">Type</span><span class="value">${tank.type}</span></div>
      <div class="row"><span class="label">Shape</span><span class="value">${tank.shape}</span></div>
      <div class="row"><span class="label">Capacity</span><span class="value">${tank.capacity} L</span></div>
      <div class="row"><span class="label">Height</span><span class="value">${tank.height} m</span></div>
      <div class="row"><span class="label">Status</span><span class="value" style="color:${tank.isActive ? 'var(--success)' : 'var(--danger)'}">${tank.isActive ? 'ACTIVE' : 'INACTIVE'}</span></div>
    </div>
    
    ${tank.deviceId && firebaseDb ? `
      <div class="card">
        <h4>
          <i class="fas fa-satellite-dish"></i> LIVE SENSOR DATA 
          <span class="live-indicator"></span>
          <span style="font-size:10px;color:#4caf50;margin-left:8px">🔥 LIVE</span>
        </h4>
        ${hasSensorData ? `
          <div class="row">
            <span class="label">Water Level</span>
            <span class="value">${sensorData.waterLevel?.toFixed(2) || 0} m</span>
          </div>
          <div class="row">
            <span class="label">Fill Percentage</span>
            <span class="value">${sensorData.percentage?.toFixed(1) || 0}%</span>
          </div>
          <div class="row">
            <span class="label">Volume</span>
            <span class="value">${sensorData.volume?.toFixed(0) || 0} L</span>
          </div>
          <div class="row">
            <span class="label">Pressure</span>
            <span class="value">${sensorData.pressure?.toFixed(2) || 0} kPa</span>
          </div>
          <div class="row">
            <span class="label">Weight</span>
            <span class="value">${sensorData.weight?.toFixed(0) || 0} kg</span>
          </div>
          <div class="row">
            <span class="label">Status</span>
            <span class="value" style="color:${sensorData.status === 'normal' ? 'var(--success)' : sensorData.status === 'low' ? 'var(--warning)' : 'var(--danger)'}">
              ${(sensorData.status || 'UNKNOWN').toUpperCase()}
            </span>
          </div>
        ` : `
          <div style="text-align:center;padding:20px;color:var(--muted)">
            <i class="fas fa-spinner fa-spin" style="font-size:24px"></i>
            <p style="margin-top:10px">Waiting for live data from ${tank.deviceId}...</p>
            <p style="font-size:11px;margin-top:8px">Make sure the sensor is powered on and connected</p>
          </div>
        `}
      </div>
    ` : ''}
    
    <div class="water-level-container">
      <h4 style="margin:0 0 12px 0;font-size:13px;font-weight:700;color:#0277bd">
        <i class="fas fa-water"></i> WATER LEVEL ${tank.deviceId ? '(Live)' : '(Manual)'}
      </h4>
      <div class="water-tank-visual">
        <div class="water-fill" id="waterFill" style="height:${displayPercentage}%">
          ${displayWaterLevel.toFixed(1)} m
        </div>
      </div>
      <input type="range" class="water-level-slider" id="waterLevelSlider" 
             min="0" max="${tank.height}" step="0.1" value="${displayWaterLevel}"
             ${tank.deviceId ? 'disabled title="Live data from sensor"' : ''}/>
      <div style="text-align:center;margin-top:8px;font-size:13px;color:#0277bd;font-weight:600">
        ${tank.deviceId ? 'Live water level:' : 'Adjust water level:'} 
        <span id="waterLevelDisplay">${displayWaterLevel.toFixed(1)} m</span>
      </div>
    </div>
    
    <div class="card">
      <h4><i class="fas fa-map-marker-alt"></i> LOCATION</h4>
      <div class="row"><span class="label">State</span><span class="value">${tank.state || '-'}</span></div>
      <div class="row"><span class="label">District</span><span class="value">${tank.district || '-'}</span></div>
      <div class="row"><span class="label">Mandal</span><span class="value">${tank.mandal || '-'}</span></div>
      <div class="row"><span class="label">Habitation</span><span class="value">${tank.habitation || '-'}</span></div>
      <div class="row"><span class="label">Coordinates</span><span class="value">${tank.latitude.toFixed(6)}, ${tank.longitude.toFixed(6)}</span></div>
      <button class="btn primary" onclick="map.setView([${tank.latitude},${tank.longitude}],18)">
        <i class="fas fa-crosshairs"></i> Center on Map
      </button>
    </div>
    
    <div class="card">
      <h4><i class="fas fa-sliders"></i> CONTROL</h4>
      <button class="btn success" onclick="toggleTank('${tank.tankId}', true)" ${tank.isActive ? 'disabled' : ''}>
        <i class="fas fa-play"></i> Activate
      </button>
      <button class="btn danger" onclick="toggleTank('${tank.tankId}', false)" ${!tank.isActive ? 'disabled' : ''}>
        <i class="fas fa-stop"></i> Deactivate
      </button>
    </div>
    
    <div class="card">
      <h4><i class="fas fa-tools"></i> ACTIONS</h4>
      <button class="btn" onclick="editTank('${tank.tankId}')">
        <i class="fas fa-pen"></i> Edit
      </button>
      <button class="btn danger" onclick="deleteTank('${tank.tankId}')">
        <i class="fas fa-trash"></i> Delete
      </button>
    </div>
    
    <div class="card">
      <h4><i class="fas fa-clock-rotate-left"></i> HISTORICAL DATA</h4>
      <button class="btn primary" onclick="openHistory('${tank.tankId}', 'tanks')">
        <i class="fas fa-history"></i> View History
      </button>
    </div>
  `;
}

    function generateValveSidebarContent(valve) {
      return `
        <div class="card">
          <h4><i class="fas fa-info-circle"></i> DETAILS</h4>
          <div class="row"><span class="label">ID</span><span class="value">${valve.valveId}</span></div>
          <div class="row"><span class="label">Name</span><span class="value">${valve.name}</span></div>
          <div class="row"><span class="label">Type</span><span class="value">${valve.type}</span></div>
          <div class="row"><span class="label">Category</span><span class="value">${valve.category.toUpperCase()}</span></div>
          <div class="row"><span class="label">Households</span><span class="value">${valve.households}</span></div>
          <div class="row"><span class="label">Flow Rate</span><span class="value">${valve.flowRate} L/min</span></div>
          <div class="row"><span class="label">Status</span><span class="value" style="color:${valve.isOpen ? 'var(--success)' : 'var(--danger)'}">${valve.isOpen ? 'OPEN' : 'CLOSED'}</span></div>
        </div>
        
        <div class="card">
          <h4><i class="fas fa-map-marker-alt"></i> LOCATION</h4>
          <div class="row"><span class="label">Mandal</span><span class="value">${valve.mandal || '-'}</span></div>
          <div class="row"><span class="label">Habitation</span><span class="value">${valve.habitation || '-'}</span></div>
          <div class="row"><span class="label">Coordinates</span><span class="value">${valve.latitude.toFixed(6)}, ${valve.longitude.toFixed(6)}</span></div>
          <button class="btn primary" onclick="map.setView([${valve.latitude},${valve.longitude}],18)"><i class="fas fa-crosshairs"></i> Center on Map</button>
        </div>
        
        <div class="card">
          <h4><i class="fas fa-sliders"></i> FLOW CONTROL</h4>
          <button class="btn success" onclick="toggleValve('${valve.valveId}', true)" ${valve.isOpen ? 'disabled' : ''}><i class="fas fa-check"></i> Open Valve</button>
          <button class="btn danger" onclick="toggleValve('${valve.valveId}', false)" ${!valve.isOpen ? 'disabled' : ''}><i class="fas fa-ban"></i> Close Valve</button>
        </div>
        
        <div class="card">
          <h4><i class="fas fa-tools"></i> ACTIONS</h4>
          <button class="btn" onclick="editValve('${valve.valveId}')"><i class="fas fa-pen"></i> Edit</button>
          <button class="btn danger" onclick="deleteValve('${valve.valveId}')"><i class="fas fa-trash"></i> Delete</button>
        </div>
        
        <div class="card">
          <h4><i class="fas fa-clock-rotate-left"></i> HISTORICAL DATA</h4>
          <button class="btn primary" onclick="openHistory('${valve.valveId}', 'valves')">
            <i class="fas fa-history"></i> View History
          </button>
        </div>
      `;
    }

    function closeSidebar() {
  // Stop all Firebase listeners
  firebaseListeners.forEach((listener, deviceId) => {
    firebase.database().ref(`tanks/${deviceId}`).off('value', listener);
    console.log(`🔇 Stopped Firebase listener for ${deviceId}`);
  });
  firebaseListeners.clear();
  
  document.getElementById('sidebar').classList.remove('open');
}

    // ==================== EDIT FUNCTIONS ====================
    function editTank(tankId) {
      const tank = tanks.find(t => t.tankId === tankId);
      if (!tank) return;
      
      openModal('tankModal');
      setText('tankModalTitle', 'Edit Tank');
      document.getElementById('tankModal').setAttribute('data-edit-id', tank.tankId);
      
      setValue('tankId', tank.tankId);
      setValue('tankDeviceId', tank.deviceId || '');
      setValue('tankName', tank.name);
      setValue('tankType', tank.type);
      setValue('tankShape', tank.shape || 'cylinder');
      setValue('tankCapacity', tank.capacity);
      setValue('tankWaterLevel', tank.waterLevel);
      setValue('tankDiameter', tank.diameter);
      setValue('tankHeight', tank.height);
      setValue('tankSensorHeight', tank.sensorHeight);
      setValue('tankState', tank.state || '');
      setValue('tankDistrict', tank.district || '');
      setValue('tankMandal', tank.mandal || '');
      setValue('tankHabitation', tank.habitation || '');
      setValue('tankLat', tank.latitude);
      setValue('tankLng', tank.longitude);
      setValue('tankIsActive', tank.isActive.toString());
    }

    function editValve(valveId) {
      const valve = valves.find(v => v.valveId === valveId);
      if (!valve) return;
      
      openModal('valveModal');
      setText('valveModalTitle', 'Edit Valve');
      document.getElementById('valveModal').setAttribute('data-edit-id', valve.valveId);
      
      setValue('valveId', valve.valveId);
      setValue('valveName', valve.name);
      setValue('valveType', valve.type);
      setValue('valveCategory', valve.category);
      setValue('valveHouseholds', valve.households);
      setValue('valveFlowRate', valve.flowRate || 0);
      setValue('valveMandal', valve.mandal || '');
      setValue('valveHabitation', valve.habitation || '');
      setValue('valveLat', valve.latitude);
      setValue('valveLng', valve.longitude);
      setValue('valveIsOpen', valve.isOpen.toString());
      
      if (valve.category === 'sub') {
        document.getElementById('parentValveRow').style.display = 'block';
        updateParentValveList();
        setValue('parentValve', valve.parentValveId || '');
      } else {
        document.getElementById('parentValveRow').style.display = 'none';
      }
    }

    function updateParentValveList() {
      const select = document.getElementById('parentValve');
      const mainValves = valves.filter(v => v.category === 'main');
      select.innerHTML = '<option value="">Select Main Valve</option>';
      mainValves.forEach(valve => {
        const option = document.createElement('option');
        option.value = valve.valveId;
        option.textContent = `${valve.name} (${valve.valveId})`;
        select.appendChild(option);
      });
    }

    // ==================== SUPPLY DASHBOARD ====================
    function updateSupplyDashboard() {
      if (!supplyData) return;
      
      const dashboardBody = document.getElementById('supplyDashboardBody');
      const stats = supplyData.stats || {};
      
      let html = `
        <div class="supply-summary">
          <div class="supply-summary-row">
            <span class="supply-summary-label">Total Households</span>
            <span class="supply-summary-value">${stats.totalHouseholds || 0}</span>
          </div>
          <div class="supply-summary-row">
            <span class="supply-summary-label">Served Households</span>
            <span class="supply-summary-value">${stats.servedHouseholds || 0}</span>
          </div>
          <div class="supply-summary-row">
            <span class="supply-summary-label">Coverage</span>
            <span class="supply-summary-value">${stats.coverage || '0'}%</span>
          </div>
          <div class="supply-summary-row">
            <span class="supply-summary-label">Total Flow</span>
            <span class="supply-summary-value">${stats.totalFlow || 0} L/min</span>
          </div>
          <div class="supply-summary-row">
            <span class="supply-summary-label">Avg Supply/HH</span>
            <span class="supply-summary-value">${stats.avgSupplyPerHousehold || 0} L/min</span>
          </div>
        </div>
      `;
      
      if (supplyData.regions && supplyData.regions.length > 0) {
        supplyData.regions.forEach(region => {
          html += `
            <div class="supply-region">
              <div class="supply-region-header">
                <div class="supply-region-name">${region.name}</div>
                <div class="supply-region-stats">
                  <span>${region.servedHouseholds}/${region.totalHouseholds} HH</span>
                  <span>${region.totalFlow} L/min</span>
                </div>
              </div>
              <div class="supply-region-body">
          `;
          
          region.valves.forEach(valve => {
            html += `
              <div class="supply-valve">
                <div class="supply-valve-info">
                  <div class="supply-valve-name">${valve.name}</div>
                  <div class="supply-valve-meta">${valve.households} HH • ${valve.habitation}</div>
                </div>
                <div>
                  <span class="supply-valve-status ${valve.isOpen ? 'open' : 'closed'}">
                    ${valve.isOpen ? 'OPEN' : 'CLOSED'}
                  </span>
                  <div class="supply-valve-flow">${valve.flow} L/min</div>
                </div>
              </div>
            `;
          });
          
          html += `</div></div>`;
        });
      }
      
      dashboardBody.innerHTML = html;
    }

    function toggleSupplyDashboard() {
      const dashboard = document.getElementById('supplyDashboard');
      const body = document.getElementById('supplyDashboardBody');
      const toggleBtn = document.getElementById('toggleSupplyDashboard');
      
      if (supplyDashboardCollapsed) {
        body.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fas fa-chevron-down"></i>';
        supplyDashboardCollapsed = false;
      } else {
        body.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-chevron-up"></i>';
        supplyDashboardCollapsed = true;
      }
    }

    // ==================== DRAWING FUNCTIONS ====================
    let drawRequested = false;
    function requestDrawCanvas() {
      if (drawRequested) return;
      drawRequested = true;
      requestAnimationFrame(() => {
        drawCanvas();
        drawRequested = false;
      });
    }

    function drawCanvas() {
  if (!ctx || !map) return;
  
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // Draw pipelines
  pipelines.forEach(pipe => {
    const points = pipe.nodes || pipe.points || [];
    
    if (!Array.isArray(points) || points.length === 0) {
      return; // Skip if no valid points
    }
    
    for (let i = 0; i < points.length - 1; i++) {
      const p1 = points[i];
      const p2 = points[i + 1];
      
      // Validate points
      if (!p1 || !p2 || 
          typeof p1.lat !== 'number' || typeof p1.lng !== 'number' ||
          typeof p2.lat !== 'number' || typeof p2.lng !== 'number') {
        continue; // Skip invalid points
      }
      
      const a = latLngToPixel(p1);
      const b = latLngToPixel(p2);
      
      // Check if segment has flow
      let hasFlow = false;
      let isBlocked = false;
      
      if (flowData && flowData.segments) {
        const segment = flowData.segments.find(s => 
          s.pipelineId === pipe.id && 
          s.start.lat === p1.lat && s.start.lng === p1.lng &&
          s.end.lat === p2.lat && s.end.lng === p2.lng
        );
        
        if (segment) {
          hasFlow = segment.hasFlow;
          isBlocked = segment.blocked;
        }
      }
      
      let color = '#b0b9c4';
      let glow = 'rgba(176,185,196,0.4)';
      let lineWidth = LINE_W;
      
      if (isBlocked) {
        color = '#d32f2f';
        glow = 'rgba(211,47,47,0.6)';
      } else if (hasFlow) {
        color = '#1e88e5';
        glow = 'rgba(30,136,229,0.6)';
      }
      
      ctx.shadowColor = glow;
      ctx.shadowBlur = 14;
      ctx.strokeStyle = color;
      ctx.lineWidth = lineWidth;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.beginPath();
      ctx.moveTo(a.x, a.y);
      ctx.lineTo(b.x, b.y);
      ctx.stroke();
      ctx.shadowBlur = 0;
    }
  });
  
  // Draw current pipeline being drawn
  if (currentPipeline.length > 1) {
    ctx.strokeStyle = '#9aa7b5';
    ctx.lineWidth = LINE_W;
    ctx.shadowColor = 'rgba(154,167,181,0.5)';
    ctx.shadowBlur = 8;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    const start = latLngToPixel(currentPipeline[0]);
    ctx.beginPath();
    ctx.moveTo(start.x, start.y);
    for (let i = 1; i < currentPipeline.length; i++) {
      const p = latLngToPixel(currentPipeline[i]);
      ctx.lineTo(p.x, p.y);
    }
    ctx.stroke();
    ctx.shadowBlur = 0;
  }
  
  // Draw valves
  // Draw valves
  valves.forEach(valve => {
    // Validate valve coordinates
    if (!valve || typeof valve.latitude !== 'number' || typeof valve.longitude !== 'number') {
      console.warn('Invalid valve coordinates:', valve);
      return; // Skip invalid valve
    }
    
    // Convert valve coordinates to {lat, lng} format
    const valveCoords = { lat: valve.latitude, lng: valve.longitude };
    const p = latLngToPixel(valveCoords);
    const hovered = hoveredDevice?.device === valve;
    const scale = hovered ? 1.3 : 1.0;
    const size = 32 * scale;
    
    ctx.shadowColor = valve.isOpen ? 'rgba(106,27,154,0.5)' : 'rgba(211,47,47,0.5)';
    ctx.shadowBlur = 16;
    
    ctx.fillStyle = valve.isOpen ? '#6a1b9a' : '#d32f2f';
    ctx.beginPath();
    ctx.arc(p.x, p.y, 12 * scale, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.shadowBlur = 0;
    
    // Draw household count badge
    if (valve.households > 0) {
      const badgeRadius = 10 * scale;
      const badgeX = p.x + (size / 2) - badgeRadius;
      const badgeY = p.y - (size / 2) + badgeRadius;
      
      ctx.fillStyle = valve.isOpen ? '#6a1b9a' : '#d32f2f';
      ctx.beginPath();
      ctx.arc(badgeX, badgeY, badgeRadius, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(badgeX, badgeY, badgeRadius, 0, Math.PI * 2);
      ctx.stroke();
      
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 11px Inter, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(valve.households, badgeX, badgeY);
    }
  });
  
  // Draw tanks
  // Draw tanks
  tanks.forEach(tank => {
    // Validate tank coordinates
    if (!tank || typeof tank.latitude !== 'number' || typeof tank.longitude !== 'number') {
      console.warn('Invalid tank coordinates:', tank);
      return; // Skip invalid tank
    }
    
    // Convert tank coordinates to {lat, lng} format
    const tankCoords = { lat: tank.latitude, lng: tank.longitude };
    const p = latLngToPixel(tankCoords);
    const hovered = hoveredDevice?.device === tank;
    const scale = hovered ? 1.3 : 1.0;
    const size = 40 * scale;
    
    ctx.shadowColor = tank.isActive ? 'rgba(2,136,209,0.5)' : 'rgba(117,117,117,0.5)';
    ctx.shadowBlur = 20;
    
    ctx.fillStyle = tank.isActive ? '#0288d1' : '#757575';
    ctx.beginPath();
    ctx.arc(p.x, p.y, 14 * scale, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.strokeStyle = '#ffffff';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(p.x, p.y, 14 * scale, 0, Math.PI * 2);
    ctx.stroke();
    
    ctx.shadowBlur = 0;
  });
}

    // ==================== HISTORY FUNCTIONS ====================
    let currentHistoryDevice = null;
    let currentHistoryType = null;
    let currentHistoryData = [];

    async function openHistory(deviceId, deviceType) {
      currentHistoryDevice = deviceId;
      currentHistoryType = deviceType;
      
      const device = deviceType === 'tanks' ? 
        tanks.find(t => t.tankId === deviceId) : 
        valves.find(v => v.valveId === deviceId);
      
      if (!device) return;
      
      openModal('historyModal');
      setText('historyModalTitle', `${device.name} - History`);
      
      // Set default date range (last 7 days)
      const endDate = new Date();
      const startDate = new Date();
      startDate.setDate(startDate.getDate() - 7);
      
      document.getElementById('historyStartDate').valueAsDate = startDate;
      document.getElementById('historyEndDate').valueAsDate = endDate;
      
      await loadHistory();
    }

    async function loadHistory() {
      const startDate = document.getElementById('historyStartDate').value;
      const endDate = document.getElementById('historyEndDate').value;
      
      const historyContent = document.getElementById('historyContent');
      historyContent.innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--muted);">
          <i class="fas fa-spinner fa-spin" style="font-size: 32px;"></i>
          <div style="margin-top: 12px;">Loading history...</div>
        </div>
      `;
      
      try {
        currentHistoryData = await APIService.getHistoryRange(
          currentHistoryDevice,
          currentHistoryType,
          new Date(startDate).getTime(),
          new Date(endDate).getTime()
        );
        
        renderHistory(currentHistoryData);
      } catch (error) {
        historyContent.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--muted);">
            <i class="fas fa-exclamation-triangle" style="font-size: 32px;"></i>
            <div style="margin-top: 12px;">Failed to load history</div>
          </div>
        `;
      }
    }

    function renderHistory(history) {
      const historyContent = document.getElementById('historyContent');
      
      if (!history || history.length === 0) {
        historyContent.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--muted);">
            <i class="fas fa-inbox" style="font-size: 32px;"></i>
            <div style="margin-top: 12px;">No history data available</div>
          </div>
        `;
        return;
      }
      
      let tableHTML;
      if (currentHistoryType === 'tanks') {
        tableHTML = `
          <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <thead>
              <tr style="background: #fafbfc; border-bottom: 2px solid var(--line);">
                <th style="padding: 12px; text-align: left; font-weight: 700;">Date & Time</th>
                <th style="padding: 12px; text-align: center;">Water Level</th>
                <th style="padding: 12px; text-align: center;">Volume</th>
                <th style="padding: 12px; text-align: center;">Percentage</th>
                <th style="padding: 12px; text-align: center;">Pressure</th>
                <th style="padding: 12px; text-align: center;">Status</th>
              </tr>
            </thead>
            <tbody>
              ${history.map((h, idx) => `
                <tr style="border-bottom: 1px solid #f2f4f7; ${idx % 2 === 0 ? 'background: #fafbfc;' : ''}">
                  <td style="padding: 10px;">${new Date(h.timestamp).toLocaleString()}</td>
                  <td style="padding: 10px; text-align: center; font-weight: 600;">${h.waterLevel || '-'} m</td>
                  <td style="padding: 10px; text-align: center;">${h.volume || '-'} L</td>
                  <td style="padding: 10px; text-align: center;">${h.percentage || '-'}%</td>
                  <td style="padding: 10px; text-align: center;">${h.pressure || '-'} kPa</td>
                  <td style="padding: 10px; text-align: center;">
                    <span style="padding: 4px 8px; border-radius: 6px; background: ${h.status === 'normal' ? '#e9f7ee' : h.status === 'low' ? '#fff4e6' : '#fdeaea'}; color: ${h.status === 'normal' ? 'var(--success)' : h.status === 'low' ? 'var(--warning)' : 'var(--danger)'}; font-weight: 600; font-size: 11px;">
                      ${(h.status || 'unknown').toUpperCase()}
                    </span>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } else {
        tableHTML = `
          <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <thead>
              <tr style="background: #fafbfc; border-bottom: 2px solid var(--line);">
                <th style="padding: 12px; text-align: left; font-weight: 700;">Date & Time</th>
                <th style="padding: 12px; text-align: center;">Valve State</th>
                <th style="padding: 12px; text-align: center;">Flow Rate</th>
                <th style="padding: 12px; text-align: center;">Pressure</th>
              </tr>
            </thead>
            <tbody>
              ${history.map((h, idx) => `
                <tr style="border-bottom: 1px solid #f2f4f7; ${idx % 2 === 0 ? 'background: #fafbfc;' : ''}">
                  <td style="padding: 10px;">${new Date(h.timestamp).toLocaleString()}</td>
                  <td style="padding: 10px; text-align: center;">
                    <span style="padding: 4px 8px; border-radius: 6px; background: ${h.isOpen ? '#e9f7ee' : '#fdeaea'}; color: ${h.isOpen ? 'var(--success)' : 'var(--danger)'}; font-weight: 600; font-size: 11px;">
                      ${h.isOpen ? 'OPEN' : 'CLOSED'}
                    </span>
                  </td>
                  <td style="padding: 10px; text-align: center; font-weight: 600;">${h.flowRate || '-'} L/min</td>
                  <td style="padding: 10px; text-align: center;">${h.pressure || '-'} kPa</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      }
      
      historyContent.innerHTML = tableHTML;
    }

    function exportCurrentHistory() {
      if (!currentHistoryDevice || !currentHistoryData) return;
      
      // Convert to CSV
      let csvContent = "data:text/csv;charset=utf-8,";
      
      if (currentHistoryType === 'tanks') {
        csvContent += "Timestamp,Date,Water Level (m),Volume (L),Percentage (%),Pressure (kPa),Status\n";
        currentHistoryData.forEach(h => {
          csvContent += `${h.timestamp},${new Date(h.timestamp).toLocaleString()},${h.waterLevel || ''},${h.volume || ''},${h.percentage || ''},${h.pressure || ''},${h.status || ''}\n`;
        });
      } else {
        csvContent += "Timestamp,Date,Valve State,Flow Rate (L/min),Pressure (kPa)\n";
        currentHistoryData.forEach(h => {
          csvContent += `${h.timestamp},${new Date(h.timestamp).toLocaleString()},${h.isOpen ? 'OPEN' : 'CLOSED'},${h.flowRate || ''},${h.pressure || ''}\n`;
        });
      }
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `${currentHistoryDevice}-history.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      toast('✓ History exported as CSV');
    }

    // ==================== MANAGE MODAL ====================
    function openManage() {
      openModal('manageModal');
      document.querySelectorAll('#manageModal [data-tab]').forEach(b => b.classList.remove('primary'));
      document.querySelector('#manageModal [data-tab="tanks"]').classList.add('primary');
      renderManage('tanks');
    }

    function renderManage(tab) {
      const content = document.getElementById('manageContent');
      
      if (tab === 'tanks') {
        if (tanks.length === 0) {
          content.innerHTML = '<div class="card" style="text-align:center;color:var(--muted)">No tanks</div>';
          return;
        }
        
        content.innerHTML = '<div class="manage-list">' + tanks.map(t => `
          <div class="manage-item">
            <div class="manage-item-info">
              <div class="manage-item-title">${t.name}</div>
              <div class="manage-item-meta">${t.tankId} • ${t.type} • ${t.capacity}L</div>
            </div>
            <div class="manage-item-actions">
              <button class="btn primary" onclick="viewTank('${t.tankId}')"><i class="fas fa-eye"></i></button>
              <button class="btn" onclick="editTank('${t.tankId}')"><i class="fas fa-pen"></i></button>
              <button class="btn danger" onclick="deleteTank('${t.tankId}')"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        `).join('') + '</div>';
      } else if (tab === 'valves') {
        if (valves.length === 0) {
          content.innerHTML = '<div class="card" style="text-align:center;color:var(--muted)">No valves</div>';
          return;
        }
        
        content.innerHTML = '<div class="manage-list">' + valves.map(v => `
          <div class="manage-item">
            <div class="manage-item-info">
              <div class="manage-item-title">${v.name}</div>
              <div class="manage-item-meta">${v.valveId} • ${v.category.toUpperCase()} • ${v.households} HH</div>
            </div>
            <div class="manage-item-actions">
              <button class="btn primary" onclick="viewValve('${v.valveId}')"><i class="fas fa-eye"></i></button>
              <button class="btn" onclick="editValve('${v.valveId}')"><i class="fas fa-pen"></i></button>
              <button class="btn danger" onclick="deleteValve('${v.valveId}')"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        `).join('') + '</div>';
      } else if (tab === 'pipelines') {
        if (pipelines.length === 0) {
          content.innerHTML = '<div class="card" style="text-align:center;color:var(--muted)">No pipelines</div>';
          return;
        }
        
        content.innerHTML = '<div class="manage-list">' + pipelines.map(p => `
          <div class="manage-item">
            <div class="manage-item-info">
              <div class="manage-item-title">${p.name}</div>
              <div class="manage-item-meta">${p.type} • ${p.diameter}mm • ${p.capacity}L/min</div>
            </div>
            <div class="manage-item-actions">
              <button class="btn primary" onclick="centerPipeline('${p.id}')"><i class="fas fa-crosshairs"></i></button>
              <button class="btn" onclick="editPipeline('${p.id}')"><i class="fas fa-pen"></i></button>
              <button class="btn danger" onclick="deletePipeline('${p.id}')"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        `).join('') + '</div>';
      } else if (tab === 'data') {
        const stats = supplyData?.stats || {};
        
        content.innerHTML = `
          <div class="card">
            <h4><i class="fas fa-cloud"></i> SYSTEM STATUS</h4>
            <div class="row"><span class="label">Connection</span><span class="value" style="color:${isConnected ? 'var(--success)' : 'var(--danger)'}">${isConnected ? 'Connected' : 'Disconnected'}</span></div>
          </div>
          
          <div class="household-stats">
            <h4><i class="fas fa-home"></i> HOUSEHOLD STATISTICS</h4>
            <div class="stat-big">
              <div class="stat-big-number">${stats.servedHouseholds || 0}</div>
              <div class="stat-big-label">Households Currently Served</div>
            </div>
            <div class="stat-row">
              <span class="label">Total Households</span>
              <span class="value">${stats.totalHouseholds || 0}</span>
            </div>
            <div class="stat-row">
              <span class="label">Coverage</span>
              <span class="value">${stats.coverage || '0'}%</span>
            </div>
            <div class="stat-row">
              <span class="label">Total Flow</span>
              <span class="value">${stats.totalFlow || 0} L/min</span>
            </div>
            <div class="stat-row">
              <span class="label">Avg Supply/HH</span>
              <span class="value">${stats.avgSupplyPerHousehold || 0} L/min</span>
            </div>
          </div>
          
          <div class="card">
            <h4><i class="fas fa-info-circle"></i> SYSTEM STATISTICS</h4>
            <div class="row"><span class="label">Tanks</span><span class="value">${tanks.length}</span></div>
            <div class="row"><span class="label">Valves</span><span class="value">${valves.length}</span></div>
            <div class="row"><span class="label">Pipelines</span><span class="value">${pipelines.length}</span></div>
            <div class="row"><span class="label">Total Capacity</span><span class="value">${tanks.reduce((sum, t) => sum + t.capacity, 0).toLocaleString()} L</span></div>
          </div>
          
          <div class="card">
            <h4><i class="fas fa-file-export"></i> EXPORT DATA</h4>
            <button class="btn success" onclick="exportAllData()"><i class="fas fa-download"></i> Export JSON</button>
          </div>
          
          <div class="card">
            <h4><i class="fas fa-file-import"></i> IMPORT DATA</h4>
            <button class="btn primary" onclick="document.getElementById('importFile').click()"><i class="fas fa-upload"></i> Import JSON</button>
          </div>
        `;
      }
    }

    function viewTank(tankId) {
      const tank = tanks.find(t => t.tankId === tankId);
      if (tank) {
        closeModal('manageModal');
        map.setView([tank.latitude, tank.longitude], 17);
        showDevice(tank, 'tank');
      }
    }

    function viewValve(valveId) {
      const valve = valves.find(v => v.valveId === valveId);
      if (valve) {
        closeModal('manageModal');
        map.setView([valve.latitude, valve.longitude], 17);
        showDevice(valve, 'valve');
      }
    }

    function centerPipeline(pipelineId) {
      const pipe = pipelines.find(p => p.id === pipelineId);
      if (!pipe || !pipe.nodes || pipe.nodes.length === 0) return;
      const mid = pipe.nodes[Math.floor(pipe.nodes.length / 2)];
      map.setView([mid.lat, mid.lng], Math.max(map.getZoom(), 16));
      closeModal('manageModal');
    }

    function editPipeline(pipelineId) {
      const pipe = pipelines.find(p => p.id === pipelineId);
      if (!pipe) return;
      
      openModal('pipelineModal');
      document.getElementById('pipelineModal').setAttribute('data-pipe-id', pipelineId);
      
      setValue('pipelineName', pipe.name);
      setValue('pipelineType', pipe.type);
      setValue('pipelineDiameter', pipe.diameter);
      setValue('pipelineCapacity', pipe.capacity);
      setValue('pipelineStart', pipe.startPoint || '');
      setValue('pipelineEnd', pipe.endPoint || '');
      setValue('pipelineNotes', pipe.notes || '');
    }

    async function exportAllData() {
      try {
        const data = await APIService.exportData();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `water-system-export-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
        toast('✓ Data exported');
      } catch (error) {
        toast('❌ Failed to export data');
      }
    }

    async function importData(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      showLoading(true);
      const reader = new FileReader();
      
      reader.onload = async () => {
        try {
          const data = JSON.parse(reader.result);
          await APIService.importData(data);
          
          await loadAllData();
          toast('✓ Data imported successfully');
        } catch (error) {
          toast('❌ Failed to import data');
        } finally {
          showLoading(false);
        }
      };
      
      reader.readAsText(file);
      e.target.value = '';
    }

    async function clearAll() {
      if (!confirm('⚠️ Clear ALL data? This cannot be undone!')) return;
      
      showLoading(true);
      
      try {
        // Delete all data
        const deletePromises = [
          ...tanks.map(t => APIService.deleteTank(t.tankId)),
          ...valves.map(v => APIService.deleteValve(v.valveId)),
          ...pipelines.map(p => APIService.deletePipeline(p.id))
        ];
        
        await Promise.allSettled(deletePromises);
        
        // Reload empty state
        await loadAllData();
        toast('✓ All data cleared');
      } catch (error) {
        toast('❌ Failed to clear data');
      } finally {
        showLoading(false);
      }
    }

    // ==================== INITIALIZATION ====================
    function initUI() {
      // Tool buttons
      bindBtn('toolPipeline', () => setMode('pipeline'));
      bindBtn('toolTank', () => setMode('tank'));
      bindBtn('toolValve', () => setMode('valve'));
      bindBtn('toolErase', () => setMode('erase'));
      bindBtn('toolManage', openManage);
      bindBtn('toolImport', () => document.getElementById('importFile').click());
      bindBtn('toolClear', clearAll);
      
      // Layer buttons
      bindBtn('layerStreet', () => switchMapLayer('street'));
      bindBtn('layerSatellite', () => switchMapLayer('satellite'));
      bindBtn('layerDark', () => switchMapLayer('dark'));
      
      // Zoom buttons
      bindBtn('zoomIn', () => map.zoomIn());
      bindBtn('zoomOut', () => map.zoomOut());
      
      // Sidebar
      bindBtn('closeSidebar', closeSidebar);
      bindBtn('toggleSupplyDashboard', toggleSupplyDashboard);
      
      // Modal close buttons
      document.querySelectorAll('[data-close]').forEach(btn => {
        btn.addEventListener('click', () => closeModal(btn.getAttribute('data-close')));
      });
      
      // Save buttons
      bindBtn('saveTank', onSaveTank);
      bindBtn('saveValve', onSaveValve);
      bindBtn('savePipeline', onSavePipeline);
      bindBtn('deleteThisPipeline', () => {
        const pipeId = document.getElementById('pipelineModal').getAttribute('data-pipe-id');
        if (pipeId) deletePipeline(pipeId);
      });
      
      // Valve category change
      const valveCategory = document.getElementById('valveCategory');
      if (valveCategory) {
        valveCategory.addEventListener('change', (e) => {
          const parentRow = document.getElementById('parentValveRow');
          if (parentRow) {
            parentRow.style.display = e.target.value === 'sub' ? 'block' : 'none';
            if (e.target.value === 'sub') updateParentValveList();
          }
        });
      }
      
      // History
      bindBtn('filterHistoryBtn', loadHistory);
      bindBtn('exportHistoryBtn', exportCurrentHistory);
      
      // Import file
      const importFile = document.getElementById('importFile');
      if (importFile) {
        importFile.addEventListener('change', importData);
      }
      
      // Manage modal tabs
      document.getElementById('manageModal').addEventListener('click', (e) => {
        const tab = e.target.closest('[data-tab]');
        if (tab) {
          document.querySelectorAll('#manageModal [data-tab]').forEach(b => b.classList.remove('primary'));
          tab.classList.add('primary');
          renderManage(tab.getAttribute('data-tab'));
        }
      });
    }

    async function initialize() {
      showLoading(true);
      
      try {
        initMap();
        initCanvas();
        initUI();
        
        await loadAllData();
        
        // Auto-refresh data every 30 seconds
        setInterval(async () => {
          if (isConnected) {
            await loadFlowData();
            await loadSupplyOverview();
            requestDrawCanvas();
          }
        }, 30000);
        
      } catch (error) {
        console.error('Initialization error:', error);
        toast('⚠️ Initialization failed');
      } finally {
        showLoading(false);
      }
    }

    // ==================== GLOBAL EXPORTS ====================
    window.openHistory = openHistory;
    window.loadHistory = loadHistory;
    window.exportCurrentHistory = exportCurrentHistory;
    window.map = map;
    window.editTank = editTank;
    window.editValve = editValve;
    window.deleteTank = deleteTank;
    window.deleteValve = deleteValve;
    window.deletePipeline = deletePipeline;
    window.editPipeline = editPipeline;
    window.centerPipeline = centerPipeline;
    window.viewTank = viewTank;
    window.viewValve = viewValve;
    window.toggleValve = toggleValve;
    window.toggleTank = toggleTank;
    window.switchMapLayer = switchMapLayer;
    window.exportAllData = exportAllData;
    window.clearAll = clearAll;

    // Start the application
    document.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>